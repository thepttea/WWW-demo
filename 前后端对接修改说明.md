# å‰åç«¯å¯¹æ¥ä¿®æ”¹è¯´æ˜

## ğŸ“‹ ä¿®æ”¹æ¦‚è¿°

æœ¬æ¬¡ä¿®æ”¹å°†å‰ç«¯ä»ä½¿ç”¨é™æ€æ•°æ®æ”¹ä¸ºçœŸæ­£è°ƒç”¨åç«¯APIæ¥å£ï¼Œå®ç°å®Œæ•´çš„å‰åç«¯æ•°æ®äº¤äº’ã€‚

---

## ğŸ”§ ä¸»è¦ä¿®æ”¹

### 1. å‰ç«¯ä¿®æ”¹ (`frontend/src/pages/scenario1/Scenario1Page.tsx`)

#### 1.1 å¯ç”¨API Hooks

**ä¿®æ”¹å‰**:
```typescript
// import { useStartSimulation, useAddPRStrategy, ... } from '../../hooks/useApi';
// æ‰€æœ‰APIè°ƒç”¨è¢«æ³¨é‡Š
```

**ä¿®æ”¹å**:
```typescript
import { useStartSimulation, useAddPRStrategy, useSimulationResult, 
         useGenerateReport, useResetSimulation, useNetworkData } from '../../hooks/useApi';

const startSimulationMutation = useStartSimulation();
const addPRStrategyMutation = useAddPRStrategy();
// ... å…¶ä»–hooks
```

#### 1.2 `handleStartSimulation` - å¯åŠ¨æ¨¡æ‹Ÿ

**ä¿®æ”¹å‰**: ç›´æ¥è®¾ç½®å‰ç«¯çŠ¶æ€ï¼Œä½¿ç”¨é™æ€æ•°æ®

**ä¿®æ”¹å**:
```typescript
const handleStartSimulation = async (config: SimulationConfig) => {
  try {
    message.loading('Starting simulation...', 0);
    const result = await startSimulationMutation.mutateAsync({
      initialTopic: config.eventDescription,
      llmModel: config.llm,
      simulationConfig: {
        agents: 10,
        num_rounds: 1,
        // ... å…¶ä»–é…ç½®
      },
      prStrategy: config.strategy.content,
    });

    message.destroy();
    
    if (result.success && result.data) {
      setSimulationId(result.data.simulationId);
      setSimulationState({
        isRunning: true,
        currentRound: 1,
        // ... æ›´æ–°çŠ¶æ€
      });
      message.success('Simulation started successfully!');
    }
  } catch (error) {
    message.error('Failed to start simulation');
  }
};
```

**åŠŸèƒ½**:
- è°ƒç”¨åç«¯ `POST /api/scenario1/simulation/start` æ¥å£
- æ¥æ”¶è¿”å›çš„ `simulationId`
- æ›´æ–°å‰ç«¯æ¨¡æ‹ŸçŠ¶æ€
- æ˜¾ç¤ºåŠ è½½å’ŒæˆåŠŸ/å¤±è´¥æç¤º

#### 1.3 `handleStartNextRound` - å¯åŠ¨ä¸‹ä¸€è½®

**ä¿®æ”¹å‰**: åªæ›´æ–°å‰ç«¯çŠ¶æ€

**ä¿®æ”¹å**:
```typescript
const handleStartNextRound = async (strategy: string) => {
  if (!simulationId) {
    message.error('No active simulation found');
    return;
  }

  try {
    message.loading('Starting next round...', 0);
    const result = await addPRStrategyMutation.mutateAsync({
      simulationId,
      prStrategy: strategy,
    });

    message.destroy();
    
    if (result.success && result.data) {
      setSimulationState(prev => prev ? {
        ...prev,
        currentRound: result.data.round || (prev.currentRound + 1),
        strategyHistory: [
          ...prev.strategyHistory,
          {
            round: result.data.round || (prev.currentRound + 1),
            strategy: strategy,
            timestamp: new Date(),
          }
        ],
      } : undefined);
      message.success(`Round ${result.data.round} simulation completed!`);
    }
  } catch (error) {
    message.error('Next round simulation failed');
  }
};
```

**åŠŸèƒ½**:
- è°ƒç”¨åç«¯ `POST /api/scenario1/simulation/{id}/add-strategy` æ¥å£
- æ·»åŠ æ–°çš„å…¬å…³ç­–ç•¥
- æ‰§è¡Œæ–°ä¸€è½®æ¨¡æ‹Ÿ
- æ›´æ–°å‰ç«¯çŠ¶æ€

#### 1.4 `handleGenerateReport` - ç”ŸæˆæŠ¥å‘Š

**ä¿®æ”¹å‰**: ç›´æ¥æ˜¾ç¤ºç»“æœé¡µé¢ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®

**ä¿®æ”¹å**:
```typescript
const handleGenerateReport = async () => {
  if (!simulationId) {
    message.warning('Please run a simulation first');
    return;
  }

  try {
    message.loading('Generating report...', 0);
    const result = await generateReportMutation.mutateAsync({
      simulationId,
      reportType: 'comprehensive',
      includeVisualizations: true,
    });

    message.destroy();
    
    if (result.success && result.data) {
      setReportData(result.data);
      setShowResults(true);
      message.success('Report generated successfully!');
    }
  } catch (error) {
    message.error('Failed to generate report');
  }
};
```

**åŠŸèƒ½**:
- è°ƒç”¨åç«¯ `POST /api/scenario1/reports/generate` æ¥å£
- LLMè‡ªåŠ¨åˆ†ææ•´ä¸ªæ¨¡æ‹Ÿè¿‡ç¨‹
- ç”Ÿæˆèˆ†æƒ…åˆ†ææŠ¥å‘Š
- æ˜¾ç¤ºç»“æœé¡µé¢

#### 1.5 `handleReset` - é‡ç½®æ¨¡æ‹Ÿ

**ä¿®æ”¹å‰**: åªæ¸…ç†å‰ç«¯çŠ¶æ€

**ä¿®æ”¹å**:
```typescript
const handleReset = async () => {
  try {
    if (simulationId) {
      const result = await resetSimulationMutation.mutateAsync(simulationId);
      if (!result.success) {
        message.error('Failed to reset simulation on server');
        return;
      }
    }

    // é‡ç½®æ‰€æœ‰å‰ç«¯çŠ¶æ€
    setSimulationState(undefined);
    setSimulationId(null);
    setConfirmedStrategy('');
    setIsDrawerVisible(false);
    setShowResults(false);
    setReportData(null);
    
    message.success('Simulation reset successfully');
  } catch (error) {
    message.error('Failed to reset simulation');
  }
};
```

**åŠŸèƒ½**:
- è°ƒç”¨åç«¯ `POST /api/simulation/{id}/reset` æ¥å£
- æ¸…ç†åç«¯æ¨¡æ‹Ÿæ•°æ®
- é‡ç½®å‰ç«¯æ‰€æœ‰çŠ¶æ€

#### 1.6 å¯è§†åŒ–æ•°æ®æº

**ä¿®æ”¹å‰**: ä½¿ç”¨ç¡¬ç¼–ç çš„é™æ€æ•°æ®ï¼ˆçº¦200è¡Œçš„ç”¨æˆ·å’Œå¹³å°æ•°æ®ï¼‰

**ä¿®æ”¹å**:
```typescript
<VisualizationArea
  isLoading={startSimulationMutation.isPending || addPRStrategyMutation.isPending}
  networkData={networkData?.success ? networkData.data : undefined}
  simulationResult={simulationResultData?.success ? simulationResultData.data : undefined}
/>
```

**åŠŸèƒ½**:
- ä½¿ç”¨ `useNetworkData` hookè‡ªåŠ¨è·å–ç½‘ç»œæ‹“æ‰‘æ•°æ®
- ä½¿ç”¨ `useSimulationResult` hookè‡ªåŠ¨è·å–æ¨¡æ‹Ÿç»“æœ
- æ ¹æ®åç«¯å“åº”åŠ¨æ€æ›´æ–°å¯è§†åŒ–

---

## ğŸ”„ æ•°æ®æµç¨‹

### 1. å¯åŠ¨æ¨¡æ‹Ÿæµç¨‹

```
ç”¨æˆ·è¾“å…¥é…ç½®
    â†“
å‰ç«¯å‘é€: POST /api/scenario1/simulation/start
    {
      initialTopic: "äº‹ä»¶æè¿°",
      llmModel: "gpt-4-turbo",
      prStrategy: "å…¬å…³ç­–ç•¥",
      simulationConfig: {...}
    }
    â†“
åç«¯å¤„ç†:
  1. åˆ›å»ºç¤¾äº¤ç½‘ç»œ (NetworkX)
  2. åˆ›å»ºAgents (ä»personas.csv)
  3. æ‰§è¡Œç¬¬ä¸€è½®æ¨¡æ‹Ÿ (LLM + Agentå†³ç­–)
  4. ä¿å­˜çŠ¶æ€
    â†“
åç«¯è¿”å›: 
    {
      success: true,
      data: {
        simulationId: "sim_xxx",
        status: "round_completed",
        websocketUrl: "..."
      }
    }
    â†“
å‰ç«¯æ›´æ–°:
  - ä¿å­˜simulationId
  - æ›´æ–°simulationState
  - è§¦å‘ç½‘ç»œæ•°æ®å’Œç»“æœæŸ¥è¯¢
```

### 2. æ•°æ®è‡ªåŠ¨åˆ·æ–°

```typescript
// React Queryè‡ªåŠ¨ç®¡ç†æ•°æ®åˆ·æ–°
const { data: networkData } = useNetworkData(simulationId);
const { data: simulationResultData } = useSimulationResult(simulationId);

// å½“simulationIdæ”¹å˜æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨APIè·å–æœ€æ–°æ•°æ®
```

### 3. å¤šè½®ç­–ç•¥æ·»åŠ 

```
ç”¨æˆ·è¾“å…¥æ–°ç­–ç•¥
    â†“
POST /api/scenario1/simulation/{id}/add-strategy
    â†“
åç«¯æ‰§è¡Œæ–°ä¸€è½®æ¨¡æ‹Ÿ
    â†“
è¿”å›æ›´æ–°åçš„ç»“æœ
    â†“
å‰ç«¯è‡ªåŠ¨åˆ·æ–°å¯è§†åŒ–
```

---

## ğŸ“Š åç«¯APIå“åº”æ ¼å¼

### 1. å¯åŠ¨æ¨¡æ‹Ÿå“åº”

```json
{
  "success": true,
  "data": {
    "simulationId": "sim_scenario1_xxx",
    "status": "round_completed",
    "websocketUrl": "ws://localhost:8000/ws/simulation/sim_xxx",
    "result": {
      "simulationId": "sim_scenario1_xxx",
      "status": "round_completed",
      "round": 1,
      "summary": {
        "totalAgents": 10,
        "activeAgents": 10,
        "totalPosts": 8,
        "positiveSentiment": 0.3,
        "negativeSentiment": 0.4,
        "neutralSentiment": 0.3
      },
      "agents": [
        {
          "agentId": "sim_scenario1_xxx_agent_0",
          "username": "MarketingPro_Serena",
          "description": "å—…è§‰æ•é”çš„å¸‚åœºè¥é”€ä¸“å®¶",
          "influenceScore": 90,
          "primaryPlatform": "Weibo/Twitter-like",
          "emotionalStyle": "æ¿€æƒ…æ”¯æŒå‹",
          "stanceScore": 2,
          "postsSent": 1,
          "latestPost": "...",
          "isActive": true
        }
        // ... æ›´å¤šagents
      ],
      "propagationPaths": [
        {
          "from": "sim_scenario1_xxx_agent_0",
          "content": "...",
          "round": 1,
          "stance": 2
        }
        // ... æ›´å¤šä¼ æ’­è·¯å¾„
      ]
    }
  }
}
```

### 2. ç½‘ç»œæ‹“æ‰‘å“åº”

```json
{
  "success": true,
  "data": {
    "nodes": [
      {
        "id": "sim_scenario1_xxx_agent_0",
        "username": "MarketingPro_Serena",
        "platform": "Weibo/Twitter-like",
        "influenceScore": 90,
        "sentiment": "neutral"
      }
      // ... æ›´å¤šèŠ‚ç‚¹
    ],
    "edges": [
      {
        "source": "sim_scenario1_xxx_agent_0",
        "target": "sim_scenario1_xxx_agent_1",
        "strength": 0.8,
        "type": "following"
      }
      // ... æ›´å¤šè¾¹
    ]
  }
}
```

### 3. ç”ŸæˆæŠ¥å‘Šå“åº”

```json
{
  "success": true,
  "data": {
    "reportId": "report_sim_xxx_timestamp",
    "content": "## èˆ†æƒ…åˆ†ææŠ¥å‘Š\n\n### æ€»ä½“æ€åŠ¿...",
    "summary": {
      "overallSentiment": -0.1,
      "keyInsights": [
        "å…¬ä¼—å¯¹å®˜æ–¹å£°æ˜æŒæ€€ç–‘æ€åº¦",
        "éœ€è¦æ›´å¤šé€æ˜åº¦æ¥å»ºç«‹ä¿¡ä»»"
      ],
      "improvements": []
    },
    "generatedAt": "2024-01-01T12:00:00Z"
  }
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®æ ¼å¼ä¸åŒ¹é…é—®é¢˜

**é—®é¢˜**: å‰ç«¯å¯è§†åŒ–ç»„ä»¶ï¼ˆ`NetworkVisualization`ï¼‰æœŸæœ›çš„æ•°æ®æ ¼å¼ä¸åç«¯è¿”å›çš„ä¸å®Œå…¨ä¸€è‡´ã€‚

**å½“å‰çŠ¶æ€**: 
- åç«¯è¿”å›: `{ nodes: [...], edges: [...] }`
- å‰ç«¯æœŸæœ›: `{ users: [...], platforms: [...] }`

**ä¸´æ—¶æ–¹æ¡ˆ**: å‰ç«¯å¯è§†åŒ–ç»„ä»¶å½“å‰ä½¿ç”¨ç¡¬ç¼–ç çš„ç”¨æˆ·åæ˜ å°„å’Œå¹³å°é…ç½®ã€‚

**æœªæ¥æ”¹è¿›**: 
1. é€‰é¡¹A: ä¿®æ”¹åç«¯è¿”å›æ•°æ®æ ¼å¼ä»¥åŒ¹é…å‰ç«¯æœŸæœ›
2. é€‰é¡¹B: åœ¨å‰ç«¯æ·»åŠ æ•°æ®è½¬æ¢å±‚
3. é€‰é¡¹C: é‡æ„å¯è§†åŒ–ç»„ä»¶ä»¥æ¥å—åç«¯æ ¼å¼

### 2. ChatInterfaceå·²ç»é›†æˆ

`ChatInterface` ç»„ä»¶å·²ç»æ­£ç¡®é›†æˆäº†åç«¯API:
- ä½¿ç”¨ `useInitChatSession` åˆå§‹åŒ–ä¼šè¯
- ä½¿ç”¨ `useSendChatMessage` å‘é€æ¶ˆæ¯
- ä½¿ç”¨ `useChatHistory` è·å–å†å²è®°å½•

æ— éœ€ä¿®æ”¹ã€‚

### 3. æ¨¡æ‹Ÿæ€§èƒ½

- æ¯ä¸ªAgentæ¯è½®éƒ½ä¼šè°ƒç”¨LLM API
- 10ä¸ªAgentéœ€è¦çº¦10-30ç§’å®Œæˆä¸€è½®
- å»ºè®®ä¸è¦è¶…è¿‡20ä¸ªAgent

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### å‰ç«¯æµ‹è¯•

- [ ] å¯åŠ¨å‰ç«¯æœåŠ¡ï¼Œè®¿é—® http://localhost:3000
- [ ] è¿›å…¥Scenario 1é¡µé¢
- [ ] è¾“å…¥äº‹ä»¶æè¿°å’Œç­–ç•¥
- [ ] ç‚¹å‡»"Start Simulation"ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºåŠ è½½æç¤º
- [ ] ç­‰å¾…æ¨¡æ‹Ÿå®Œæˆï¼Œæ£€æŸ¥å¯è§†åŒ–æ˜¯å¦æ›´æ–°
- [ ] æ·»åŠ æ–°ç­–ç•¥ï¼Œç‚¹å‡»"Start Next Round Simulation"
- [ ] ç‚¹å‡»"Generate Report"ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæŠ¥å‘Š
- [ ] ç‚¹å‡»"Reset"ï¼Œæ£€æŸ¥æ˜¯å¦æ¸…ç†çŠ¶æ€

### åç«¯æµ‹è¯•

- [ ] è®¿é—® http://localhost:8000/docs
- [ ] æµ‹è¯• `/api/scenario1/chat/init` æ¥å£
- [ ] æµ‹è¯• `/api/scenario1/simulation/start` æ¥å£
- [ ] æ£€æŸ¥ç»ˆç«¯æ—¥å¿—ï¼Œç¡®è®¤Agentåˆ›å»ºå’Œæ¨¡æ‹Ÿæ‰§è¡Œ
- [ ] æŸ¥çœ‹ç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹

### é›†æˆæµ‹è¯•

- [ ] å‰ç«¯å¯åŠ¨æ¨¡æ‹Ÿåï¼Œåç«¯ç»ˆç«¯æ˜¾ç¤ºç›¸å…³æ—¥å¿—
- [ ] å‰ç«¯å¯è§†åŒ–åŒºåŸŸæ˜¾ç¤ºç½‘ç»œå›¾ï¼ˆå³ä½¿å½“å‰ä½¿ç”¨é™æ€æ•°æ®ï¼‰
- [ ] ç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹åˆç†
- [ ] å¤šè½®æ¨¡æ‹Ÿæ­£å¸¸å·¥ä½œ
- [ ] é”™è¯¯å¤„ç†æ­£å¸¸ï¼ˆå¦‚APIå¯†é’¥é”™è¯¯ï¼‰

---

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®é€‚é…å±‚

åˆ›å»º `frontend/src/utils/dataAdapter.ts`:

```typescript
export function transformNetworkData(backendData: any) {
  // å°†åç«¯çš„ nodes/edges æ ¼å¼è½¬æ¢ä¸ºå‰ç«¯çš„ users/platforms æ ¼å¼
  const users = backendData.agents.map(agent => ({
    username: agent.username,
    influence_score: agent.influenceScore,
    primary_platform: agent.primaryPlatform,
    emotional_style: agent.emotionalStyle,
    final_decision: agent.latestPost,
    objective_stance_score: agent.stanceScore
  }));
  
  // æ„å»ºplatformsæ•°æ®...
  
  return { users, platforms };
}
```

### 2. WebSocketå®æ—¶æ›´æ–°

å½“å‰ä½¿ç”¨è½®è¯¢ï¼ˆReact Queryè‡ªåŠ¨åˆ·æ–°ï¼‰ï¼Œå¯ä»¥æ”¹ä¸ºWebSocketè·å–å®æ—¶æ›´æ–°ã€‚

### 3. ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

é…ç½®React Queryçš„ç¼“å­˜ç­–ç•¥ï¼Œå‡å°‘ä¸å¿…è¦çš„APIè°ƒç”¨ã€‚

### 4. é”™è¯¯è¾¹ç•Œ

æ·»åŠ é”™è¯¯è¾¹ç•Œç»„ä»¶ï¼Œæå‡é”™è¯¯å¤„ç†ä½“éªŒã€‚

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### å·²ä¿®æ”¹æ–‡ä»¶

1. `frontend/src/pages/scenario1/Scenario1Page.tsx` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
   - å–æ¶ˆæ³¨é‡Šæ‰€æœ‰API hooks
   - é‡å†™æ‰€æœ‰handlerå‡½æ•°ä»¥è°ƒç”¨çœŸå®API
   - æ›´æ–°å¯è§†åŒ–æ•°æ®æº

### éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶

1. `frontend/src/services/api.ts` - APIå®¢æˆ·ç«¯ï¼ˆæ— éœ€ä¿®æ”¹ï¼Œå·²æ­£ç¡®å®ç°ï¼‰
2. `frontend/src/hooks/useApi.ts` - React Query hooksï¼ˆæ— éœ€ä¿®æ”¹ï¼Œå·²æ­£ç¡®å®ç°ï¼‰
3. `frontend/src/components/ChatInterface.tsx` - èŠå¤©ç•Œé¢ï¼ˆæ— éœ€ä¿®æ”¹ï¼Œå·²é›†æˆAPIï¼‰

### æ–°å¢æ–‡ä»¶

1. `è¿è¡ŒæŒ‡å—.md` - å®Œæ•´çš„è¿è¡Œè¯´æ˜æ–‡æ¡£
2. `å‰åç«¯å¯¹æ¥ä¿®æ”¹è¯´æ˜.md` - æœ¬æ–‡ä»¶

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¿®æ”¹æˆåŠŸå°†å‰ç«¯ä»é™æ€æ•°æ®æ¨¡å¼æ”¹ä¸ºçœŸæ­£è°ƒç”¨åç«¯APIï¼Œå®ç°äº†ï¼š

âœ… å®Œæ•´çš„æ¨¡æ‹Ÿå¯åŠ¨æµç¨‹
âœ… å¤šè½®ç­–ç•¥æ·»åŠ å’Œæ¨¡æ‹Ÿ
âœ… LLMæŠ¥å‘Šç”Ÿæˆ
âœ… çŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç†
âœ… åŠ è½½æç¤ºå’Œç”¨æˆ·åé¦ˆ

å‰åç«¯ç°å·²æˆåŠŸå¯¹æ¥ï¼Œå¯ä»¥è¿›è¡Œç«¯åˆ°ç«¯çš„èˆ†è®ºæ¨¡æ‹Ÿäº†ï¼

